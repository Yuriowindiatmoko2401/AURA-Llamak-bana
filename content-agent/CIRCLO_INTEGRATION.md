# Circlo Integration Guide

This document explains how to use the new Circlo posting functionality that has been integrated into the content generation pipeline.

## Overview

The system now supports posting content to both Telegram and Circlo platforms. Content can be posted to Circlo's create-post API using the exact JSON format you specified:

```json
{
    "profile": "general",
    "niche": "Tech Reviewer",
    "media_type": "image",
    "media_source": "https://replicate.delivery/pbxt/.../output.jpg",
    "caption": "Check out this amazing tech review!",
    "keywords": ["tech", "review", "gadgets"]
}
```

## Field Values Explained

### profile
- **Source**: `user_preferences.profile_type` (defaults to "general")
- **Purpose**: Determines the posting profile category in Circlo

### niche
- **Source**: `user_preferences.niche` or extracted from user message
- **Purpose**: Content category for targeting and classification

### media_type
- **Source**: Determined automatically based on content
- **Values**: "image" if image_url present, otherwise "text"
- **Purpose**: Specifies the type of content being posted

### media_source
- **Source**: `content.image_url` (from image generation)
- **Purpose**: URL of the generated image to be posted
- **Only included** when media_type is "image"

### caption
- **Source**: Generated by ContentCrew AI system
- **Purpose**: The main text content of the post
- **Length**: Optimized for engagement (100-200 characters typically)

### keywords
- **Source**: Combination of user preferences, trend research, and hashtag optimization
- **Purpose**: SEO and discovery optimization
- **Format**: Cleaned array of strings (no hashtags, spaces, or special characters)

## Configuration

### Environment Variables

Add these to your `.env` file:

```env
# Enable Circlo posting (optional, can be enabled via API)
ENABLE_CIRCLO_POSTING=true

# Required for Circlo API access
CIRCLO_JWT=your_jwt_token_here
```

### Platform Control

You can enable/disable Circlo posting via:

1. **Environment Variable**: Set `ENABLE_CIRCLO_POSTING=true` in `.env`
2. **API Endpoints**: Use the platform management endpoints

## API Endpoints

### Get Platform Status
```bash
GET /platforms
```

Returns current platform configuration and status.

### Enable Circlo Posting
```bash
POST /platforms/circlo/enable
```

Enables Circlo posting for all future content generation.

### Disable Circlo Posting
```bash
POST /platforms/circlo/disable
```

Disables Circlo posting (content will only go to Telegram).

### Test Circlo Posting
```bash
POST /test-circlo-post
```

Tests the Circlo posting functionality with sample data.

## How It Works

### 1. Content Generation Pipeline
When content is generated through the webhook or scheduling system:

1. **Entity Extraction**: User message is analyzed for topic and scheduling
2. **Content Creation**: CrewAI generates captions, hashtags, and image concepts
3. **Image Generation**: Images are created using Replicate API
4. **Multi-Platform Posting**: Content is posted to enabled platforms (Telegram + Circlo)

### 2. Platform Selection
The system posts to:
- **Telegram**: Always enabled (default behavior)
- **Circlo**: Only when `ENABLE_CIRCLO_POSTING=true`

### 3. Error Handling
- If one platform fails, others continue to work
- Results are tracked per platform
- Overall status: "success", "partial_failure", or "error"

## Usage Examples

### Enable Circlo and Create Content
```bash
# 1. Check current platform status
curl http://localhost:8000/platforms

# 2. Enable Circlo posting
curl -X POST http://localhost:8000/platforms/circlo/enable

# 3. Test with sample data
curl -X POST http://localhost:8000/test-circlo-post

# 4. Generate content (will now post to both platforms)
curl -X POST http://localhost:8000/circlo-hook \
  -H "Content-Type: application/json" \
  -d '{"message":"create tech review posts","user":{"id":"test","name":"Test","preferredKeywords":["tech"],"preferredNiches":["review"]},"profile":{"id":"tech","name":"Tech","niche":"technology"}}'
```

### Monitor Results
```bash
# Check health status (includes platform info)
curl http://localhost:8000/health

# Check active schedules
curl http://localhost:8000/schedules

# Monitor debug sessions
curl http://localhost:8000/debug/sessions
```

## Testing

Run the test script to verify functionality:

```bash
cd content-agent
python test_circlo_posting.py
```

This will:
- Test content formatting logic
- Verify the JSON structure matches your specification
- Test API connection (requires valid JWT)
- Show example payloads for different scenarios

## Troubleshooting

### Common Issues

1. **"Access token is required"**
   - Ensure `CIRCLO_JWT` is set in your environment
   - Verify the JWT token is valid and not expired

2. **Circlo posting not working**
   - Check if `ENABLE_CIRCLO_POSTING=true` is set
   - Use `/platforms` endpoint to verify status
   - Enable via `/platforms/circlo/enable` endpoint

3. **Content format issues**
   - Run the test script to verify formatting
   - Check that captions and keywords are properly cleaned

### Debug Information

- Use `/debug/sessions` to monitor content generation flow
- Check logs for platform-specific errors
- Each platform's results are tracked separately

## Security Notes

- JWT tokens should be kept secure and not shared
- Circlo posting is disabled by default for safety
- API endpoints respect the same authentication as the main application

## Future Enhancements

Potential improvements:
1. **Platform-Specific Optimization**: Different caption lengths for each platform
2. **Content Variations**: Generate slightly different content for each platform
3. **Analytics Integration**: Track engagement metrics from both platforms
4. **Retry Logic**: Automatic retry for failed posts
5. **Content Scheduling**: Platform-specific optimal posting times

## File Structure

Key files modified/added for Circlo integration:

- `agents/circlo_client.py` - Enhanced with posting functions
- `main.py` - Added platform management and multi-platform posting
- `test_circlo_posting.py` - Test script for verification
- `CIRCLO_INTEGRATION.md` - This documentation

The integration is designed to be backward compatible - existing Telegram functionality continues to work unchanged, while Circlo is an optional addition.